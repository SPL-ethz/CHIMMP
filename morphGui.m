function morphGui

% Copyright 2016 David Ochsenbein
% 
% This file is part of CHIMMP.
% 
% CHIMMP is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation version 3 of the License.
% 
% CHIMMP is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.

close all
clear

if exist('tbxmanager','file')
    tbxmanager restorepath
end
    
if ~exist('mpt_init','file')

    s = input('Could not find geometry toolboxes. Would you like to download them [y/n]? ','s');

    if strcmpi(s,'y')
        urlwrite('http://www.tbxmanager.com/tbxmanager.m', 'tbxmanager.m');
        rehash

        tbxmanager install fourier cddmex lcp mpt

    else
        error('mapDrawer:mptNotFound',...
            'Could not locate the geometry toolboxes in search path.');
    end

end

global hp Ival crysnameslist hpu milstr

%load crystalData from .mat file
Crystals = evalin('base', 'load(''CrystalData.mat'')'); %loads data into base workspace.. not function workspace 
Crystals = Crystals.Crystals;

%remove data with M matrices with only 2 columns
Mc = struct2cell(Crystals);
Mc = Mc(6,:);
I = false(length(Mc),1);
for i = 1:length(Mc)
    if length(Mc{i}(1,:))~=3
        I(i) = false;
    else
        I(i) = true;
    end
end
Crystals = Crystals(I,:);
Crystals(1).heteronyms{1,1};

%create a nameslist of the crystals from CrystalData.mat for popupmenu
for j = 1:length(Crystals);
    for i = 1:length(Crystals(j).heteronyms);
    crysnames{j,i} = Crystals(j).heteronyms{1,i};
    end
end

crysnameslist = crysnames(:,1);

%load data for the first map drawing
crysname = crysnames(1);
crystal = getCrystalInfo(crysname);

%Prepare the gui figure
hf = figure;

set(hf,'position',[300 150 1200 700],'color','w','menubar','none')
ha1 = axes('position',[0.075 0.175 0.5 0.8]);

ha2 = axes('position',[0.6 0.175 0.35 0.4]);

hslider = [];

%dropdownlist with crysnameslist data from the file CrystalData.mat
hpu = uicontrol(hf,'style','popupmenu','units','normalized','position',[0.65    0.6    0.2500    0.2000],'string',crysnameslist,...
    'fontsize',14,'callback',@popupcallback,'backgroundcolor','w');

%create snapshot button
snapbut = uicontrol(hf,'style','pushbutton',...
                    'string','Snapshot',...
                    'units','normalized',...
                    'position',[0.9 0 0.1 0.05],...
                    'callback',@snapshot...
                    );

try
    rvec = evalin('base','r1vec');
    U = evalin('base','U');
    crystal = evalin('base','crystal');
    Cmat = evalin('base','Cmat');
catch
    updateMap
end                
                
function posChange(pos)
    axes(ha2);
    cla
    
    if ndims(U) == 2
        L = round([1 exp(pos(1)) exp(pos(2))]'*1e3)/1e3;
    elseif ndims(U) == 3
        sliderVal = get(hslider,'value');
        sliceI = round(sliderVal*(length(rvec{3})-1))+1;
        L = round([1 exp(pos(1)) exp(pos(2)) rvec{3}(sliceI)*exp(pos(2))]'*1e3)/1e3;
    end

    Pbase = Polyhedron(crystal.H,ones(size(crystal.H,1),1));
    P = Polyhedron(crystal.H,crystal.M*L);

    plot(P)
    axis equal
    axis off
    hold on
    crystal.Mfull = crystal.M;
    
    [pFace] = colorCrystal(Pbase,P,crystal.Mfull,[]);
    
    AA = get(findall(gcf,'type','patch'),'vertices');
    BB = get(findall(gcf,'type','patch'),'faces');
    
    if length(AA(:,1)) == length(BB(:,1))
        set(findall(gcf,'type','patch'),'vertices',[AA; 0 0 0]);
    end
    
    set(findall(hf,'type','patch'),'facevertexcdata',pFace,'facecolor','flat','facealpha',1)
    
    if ndims(U) == 2
        htit = title(['h = [1, ',num2str(L(2),'%4.2f'),', ',num2str(L(3),'%4.2f'),']'],'fontsize',14);
        set(htit,'units','normalized','position',[0.5 1 0])
    elseif ndims(U) == 3
        htit = title(['h = [1, ',num2str(L(2),'%4.2f'),', ',num2str(L(3),'%4.2f'),', ',num2str(L(4),'%4.2f'),']'],'fontsize',14);
        set(htit,'units','normalized','position',[0.5 1 0])
    end
    
end

%function to be called when an item is selected from the dropdownlist
function popupcallback(source,callbackdata)
    val = source.Value;
    crysname = crysnames{val};
    crystal = getCrystalInfo(crysname);
    updateMap
end

%function to redraw the Map
    function updateMap(crysname)
        if nargin<1 
%             [m,n] = size(crystal.H);
%             for i = 1:m
%                 crystal.M(i,n+1) = 0;    
%             end
            
%                     crystal.M = [1,0,0,0;
%                         1,0,0,0;
%                         1,0,0,0;
%                         1,0,0,0;
%                         0,1,0,0;
%                         0,1,0,0;
%                         0,0,1,0;
%                         0,0,1,0;
%                         0,0,0,1;
%                         0,0,0,1;
%                         0,0,0,1;
%                         0,0,0,1;]; %10x4
            
        %crystal = getCrystalInfo(crystal.heteronyms);
        
% %Acetaminophen          
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,0,1;0,0,1;0,0,1;0,0,1];
% crystal.H = [0.861989238633940,0,0.506926575037530;-0.595530206511683,0,0.803332915503997;0.595530206511683,0,-0.803332915503997;-0.861989238633940,0,-0.506926575037530;0.432400521409168,0,0.901681645086047;-0.432400521409168,0,-0.901681645086047;0.628157063371826,0.778086565708523,0;-0.628157063371826,-0.778086565708523,0;-0.628157063371826,0.778086565708523,0;0.628157063371826,-0.778086565708523,0];
% %alglu
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,0,1;0,0,1];
% crystal.H = [0.686666441970759,0.470666512651802,0.554041723464407;0.686666441970759,0.470666512651802,-0.554041723464407;0.686666441970759,-0.470666512651802,0.554041723464407;-0.686666441970759,0.470666512651802,0.554041723464407;0.686666441970759,-0.470666512651802,-0.554041723464407;-0.686666441970759,0.470666512651802,-0.554041723464407;-0.686666441970759,-0.470666512651802,0.554041723464407;-0.686666441970759,-0.470666512651802,-0.554041723464407;0,1,0;0,-1,0;0,0,1;0,0,-1];
% %blglu
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,1,0;0,1,0;0,0,1;0,0,1];
% crystal.H = [0.802348933372825,0,0.596855249717627;-0.802348933372825,0,0.596855249717627;0.802348933372825,0,-0.596855249717627;-0.802348933372825,0,-0.596855249717627;0,0.625462992449573,0.780253833746446;0,0.625462992449573,-0.780253833746446;0,-0.625462992449573,0.780253833746446;0,-0.625462992449573,-0.780253833746446;0,1,0;0,-1,0];
% %alac
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,0,1;0,0,1];
% crystal.H = [0,1,0;0,-1,0;0.944210045951308,0.329343876707353,0;-0.944210045951308,0.329343876707353,0;0.944210045951308,-0.329343876707353,0;-0.944210045951308,-0.329343876707353,0;1,0,0;-1,0,0;-0.327755051673573,-0.206269611072421,-0.921970429921961;0.327755051673573,-0.206269611072421,0.921970429921961];
% %Ibuprofen (RS)
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,0,1;0,0,1];
% crystal.H = [0.0971741344037702,0.801970356522239,0.589407104523241;-0.0971741344037702,0.801970356522239,-0.589407104523241;0.0971741344037702,-0.801970356522239,0.589407104523241;-0.0971741344037702,-0.801970356522239,-0.589407104523241;0.162671606932611,0,0.986680266498708;-0.162671606932611,0,-0.986680266498708;1,0,0;-1,0,0];
% %KH2PO4
% crystal.M = [1,0;1,0;1,0;1,0;1,0;1,0;1,0;1,0;0,1;0,1;0,1;0,1];
% crystal.H = [0.683190852597592,0,0.730239863967297;0,0.683190852597592,0.730239863967297;0,-0.683190852597592,0.730239863967297;-0.683190852597592,0,0.730239863967297;0.683190852597592,0,-0.730239863967297;0,0.683190852597592,-0.730239863967297;-0.683190852597592,0,-0.730239863967297;0,-0.683190852597592,-0.730239863967297;1.00000000000000,0,0;-1.00000000000000,0,0;0,1.00000000000000,0;0,-1.00000000000000,0];
% %Lys
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,1,0;0,1,0;0,0,1;0,0,1;0,0,1;0,0,1];
% crystal.H = [0.431551978786294,0,0.902088071978360;-0.431551978786294,0,-0.902088071978360;0.431551978786294,0,-0.902088071978360;-0.431551978786294,0,0.902088071978360;0.707106781186548,0.707106781186548,0;-0.707106781186548,-0.707106781186548,0;0.707106781186548,-0.707106781186548,0;-0.707106781186548,0.707106781186548,0;0,0.431551978786294,0.902088071978360;0,-0.431551978786294,-0.902088071978360;0,-0.431551978786294,0.902088071978360;0,0.431551978786294,-0.902088071978360];
% %Potash Alum
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,1,0;0,1,0;0,1,0;0,1,0;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1]; %26x3?
% crystal.H = [0.577350269189626,0.577350269189626,0.577350269189626;-0.577350269189626,-0.577350269189626,-0.577350269189626;0.577350269189626,0.577350269189626,-0.577350269189626;0.577350269189626,-0.577350269189626,0.577350269189626;-0.577350269189626,0.577350269189626,0.577350269189626;-0.577350269189626,-0.577350269189626,0.577350269189626;-0.577350269189626,0.577350269189626,-0.577350269189626;0.577350269189626,-0.577350269189626,-0.577350269189626;1,0,0;-1,0,0;0,1,0;0,-1,0;0,0,1;0,0,-1;0.707106781186548,0.707106781186548,0;0.707106781186548,0,0.707106781186548;0,0.707106781186548,0.707106781186548;-0.707106781186548,-0.707106781186548,0;-0.707106781186548,0,-0.707106781186548;0,-0.707106781186548,-0.707106781186548;-0.707106781186548,0.707106781186548,0;-0.707106781186548,0,0.707106781186548;0,-0.707106781186548,0.707106781186548;0.707106781186548,-0.707106781186548,0;0.707106781186548,0,-0.707106781186548;0,0.707106781186548,-0.707106781186548];
% %NaCl
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,1,0;0,1,0;0,1,0;0,1,0;0,1,0;0,1,0;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1;0,0,1];
% crystal.H = [0.577350269189626,0.577350269189626,0.577350269189626;0.577350269189626,0.577350269189626,-0.577350269189626;0.577350269189626,-0.577350269189626,0.577350269189626;-0.577350269189626,0.577350269189626,0.577350269189626;0.577350269189626,-0.577350269189626,-0.577350269189626;-0.577350269189626,0.577350269189626,-0.577350269189626;-0.577350269189626,-0.577350269189626,0.577350269189626;-0.577350269189626,-0.577350269189626,-0.577350269189626;0.707106781186548,0.707106781186548,0;-0.707106781186548,-0.707106781186548,0;-0.707106781186548,0.707106781186548,0;0.707106781186548,-0.707106781186548,0;0,0.707106781186548,0.707106781186548;0,-0.707106781186548,-0.707106781186548;0,0.707106781186548,-0.707106781186548;0,-0.707106781186548,0.707106781186548;1,0,0;-1,0,0;0,1,0;0,-1,0;0,0,1;0,0,-1];
% %Urea
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,1,0;0,1,0;0,0,1;0,0,1];
% crystal.H = [0.536083931291917,0.536083931291917,0.652095113630831;-0.536083931291917,-0.536083931291917,0.652095113630831;-0.536083931291917,0.536083931291917,-0.652095113630831;0.536083931291917,-0.536083931291917,-0.652095113630831;0.707106781186548,0.707106781186548,0;0.707106781186548,-0.707106781186548,0;-0.707106781186548,0.707106781186548,0;-0.707106781186548,-0.707106781186548,0;0,0,1.00000000000000;0,0,-1.00000000000000];
% %Vanillin
% crystal.M = [1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,1,0;0,1,0;0,0,1;0,0,1];
% crystal.H = [0.777508524996704,0.436379428559404,0.452828320545013;0.777508524996704,0.436379428559404,-0.452828320545013;-0.777508524996704,0.436379428559404,0.452828320545013;-0.777508524996704,0.436379428559404,-0.452828320545013;0.777508524996704,-0.436379428559404,0.452828320545013;0.777508524996704,-0.436379428559404,-0.452828320545013;-0.777508524996704,-0.436379428559404,0.452828320545013;-0.777508524996704,-0.436379428559404,-0.452828320545013;0.665186832279454,0.746676957031638,0;-0.665186832279454,0.746676957031638,0;0.665186832279454,-0.746676957031638,0;-0.665186832279454,-0.746676957031638,0;1,0,0;-1,0,0];
% %cylinder
% crystal.M = [1,0;1,0;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1;0,1];
% crystal.H = [1,0,0;-1,0,0;0,1,0;0,0.998026728428272,0.0627905195293134;0,0.992114701314478,0.125333233564304;0,0.982287250728689,0.187381314585725;0,0.968583161128631,0.248689887164855;0,0.951056516295154,0.309016994374947;0,0.929776485888252,0.368124552684678;0,0.904827052466020,0.425779291565073;0,0.876306680043864,0.481753674101715;0,0.844327925502015,0.535826794978997;0,0.809016994374948,0.587785252292473;0,0.770513242775790,0.637423989748690;0,0.728968627421412,0.684547105928689;0,0.684547105928689,0.728968627421412;0,0.637423989748690,0.770513242775789;0,0.587785252292473,0.809016994374947;0,0.535826794978997,0.844327925502015;0,0.481753674101715,0.876306680043864;0,0.425779291565073,0.904827052466020;0,0.368124552684678,0.929776485888251;0,0.309016994374948,0.951056516295154;0,0.248689887164855,0.968583161128631;0,0.187381314585725,0.982287250728689;0,0.125333233564305,0.992114701314478;0,0.0627905195293135,0.998026728428272;0,6.12323399573677e-17,1;0,-0.0627905195293134,0.998026728428272;0,-0.125333233564304,0.992114701314478;0,-0.187381314585725,0.982287250728689;0,-0.248689887164855,0.968583161128631;0,-0.309016994374947,0.951056516295154;0,-0.368124552684678,0.929776485888252;0,-0.425779291565073,0.904827052466020;0,-0.481753674101715,0.876306680043864;0,-0.535826794978997,0.844327925502015;0,-0.587785252292473,0.809016994374948;0,-0.637423989748690,0.770513242775789;0,-0.684547105928689,0.728968627421412;0,-0.728968627421411,0.684547105928689;0,-0.770513242775789,0.637423989748690;0,-0.809016994374947,0.587785252292473;0,-0.844327925502015,0.535826794978997;0,-0.876306680043864,0.481753674101715;0,-0.904827052466020,0.425779291565073;0,-0.929776485888251,0.368124552684678;0,-0.951056516295154,0.309016994374948;0,-0.968583161128631,0.248689887164855;0,-0.982287250728689,0.187381314585725;0,-0.992114701314478,0.125333233564305;0,-0.998026728428272,0.0627905195293136;0,-1,1.22464679914735e-16;0,-0.998026728428272,-0.0627905195293134;0,-0.992114701314478,-0.125333233564304;0,-0.982287250728689,-0.187381314585725;0,-0.968583161128631,-0.248689887164855;0,-0.951056516295154,-0.309016994374947;0,-0.929776485888252,-0.368124552684678;0,-0.904827052466020,-0.425779291565072;0,-0.876306680043864,-0.481753674101715;0,-0.844327925502015,-0.535826794978996;0,-0.809016994374948,-0.587785252292473;0,-0.770513242775790,-0.637423989748690;0,-0.728968627421412,-0.684547105928688;0,-0.684547105928689,-0.728968627421412;0,-0.637423989748690,-0.770513242775789;0,-0.587785252292473,-0.809016994374947;0,-0.535826794978996,-0.844327925502015;0,-0.481753674101715,-0.876306680043864;0,-0.425779291565072,-0.904827052466020;0,-0.368124552684678,-0.929776485888252;0,-0.309016994374948,-0.951056516295154;0,-0.248689887164854,-0.968583161128631;0,-0.187381314585725,-0.982287250728689;0,-0.125333233564305,-0.992114701314478;0,-0.0627905195293132,-0.998026728428272;0,-1.83697019872103e-16,-1;0,0.0627905195293129,-0.998026728428272;0,0.125333233564304,-0.992114701314478;0,0.187381314585724,-0.982287250728689;0,0.248689887164855,-0.968583161128631;0,0.309016994374947,-0.951056516295154;0,0.368124552684677,-0.929776485888252;0,0.425779291565072,-0.904827052466020;0,0.481753674101716,-0.876306680043863;0,0.535826794978997,-0.844327925502015;0,0.587785252292473,-0.809016994374948;0,0.637423989748689,-0.770513242775790;0,0.684547105928688,-0.728968627421412;0,0.728968627421411,-0.684547105928689;0,0.770513242775789,-0.637423989748690;0,0.809016994374947,-0.587785252292473;0,0.844327925502015,-0.535826794978997;0,0.876306680043863,-0.481753674101716;0,0.904827052466019,-0.425779291565073;0,0.929776485888252,-0.368124552684678;0,0.951056516295154,-0.309016994374948;0,0.968583161128631,-0.248689887164855;0,0.982287250728689,-0.187381314585725;0,0.992114701314478,-0.125333233564305;0,0.998026728428272,-0.0627905195293133];
% %cuboid
% crystal.M = [1,0,0;1,0,0;0,1,0;0,1,0;0,0,1;0,0,1];
% crystal.H = [1,0,0;-1,0,0;0,1,0;0,-1,0;0,0,1;0,0,-1];

%             crystal.M = [1,0,0,0,0,0;
%                           1,0,0,0,0,0;
%                           1,0,0,0,0,0;
%                           1,0,0,0,0,0;
%                           0,1,0,0,0,0;
%                           0,1,0,0,0,0;
%                           0,0,0,1,0,0;
%                           0,0,0,1,0,0;
%                           0,0,1,0,0,0;
%                           0,0,1,0,0,0;
%                           0,0,0,0,0,1;
%                           0,0,0,0,0,1;
%                           0,0,0,0,0,1;
%                           0,0,0,0,0,1;
%                           0,0,0,0,1,0;
%                           0,0,0,0,1,0];
            
%             crystal.H = [-9.30702956532859e-17,-1.04077766150235e-16,1.00000000000000;
%                         9.30702956532859e-17,1.04077766150235e-16,-1.00000000000000;
%                         -0.760447467379201,0.614567348899053,-0.209825220180388;
%                         0.760447467379201,-0.614567348899053,0.209825220180388;
%                         -0.829652744433316,-0.486102158099949,0.274556033524742;
%                         0.829652744433316,0.486102158099949,-0.274556033524742;
%                         -0.604912610090194,0.488869455216894,0.628559774333202;
%                         0.604912610090194,-0.488869455216894,-0.628559774333202;
%                         0.148067858804268,0.916206732216432,0.372345448515765;
%                         -0.148067858804268,-0.916206732216432,-0.372345448515765];
%           
%             crystal.M = [1,0,0,0;
%                         1,0,0,0;
%                         1,0,0,0;
%                         1,0,0,0;
%                         0,1,0,0;
%                         0,1,0,0;
%                         0,0,0,1;
%                         0,0,0,1;
%                         0,0,1,0;
%                         0,0,1,0];
%                     
%             crystal.H =  [0.861989238633940,0,0.506926575037530;-0.595530206511683,0,0.803332915503997;0.595530206511683,0,-0.803332915503997;-0.861989238633940,0,-0.506926575037530;0.432400521409168,0,0.901681645086047;-0.432400521409168,0,-0.901681645086047;0.628157063371826,0.778086565708523,0;-0.628157063371826,-0.778086565708523,0;-0.628157063371826,0.778086565708523,0;0.628157063371826,-0.778086565708523,0];                   
%             crystal.M =  [1,0,0;1,0,0;1,0,0;1,0,0;0,1,0;0,1,0;0,0,1;0,0,1;0,0,1;0,0,1];
                      
%                crystal.M = [1,0,0,0;
%                             1,0,0,0;
%                             1,0,0,0;
%                             1,0,0,0;
%                             0,1,0,0;
%                             0,1,0,0;
%                             0,0,0,1;
%                             0,0,0,1;
%                             0,0,1,0;
%                             0,0,1,0;
%                             0,0,0,3.16426789911892;
%                             0,0,0,3.16426789911892;
%                             0,0,0,3.16426789911892;
%                             0,0,0,3.16426789911892;
%                             0,0,0,2.38569814452229;
%                             0,0,0,2.38569814452229];
% 
%             crystal.H = [-9.30702956532859e-17,-1.04077766150235e-16,1.00000000000000;
%                 9.30702956532859e-17,1.04077766150235e-16,-1.00000000000000;
%                 -0.760447467379201,0.614567348899053,-0.209825220180388;
%                 0.760447467379201,-0.614567348899053,0.209825220180388;
%                 -0.829652744433316,-0.486102158099949,0.274556033524742;
%                 0.829652744433316,0.486102158099949,-0.274556033524742;
%                 -0.604912610090194,0.488869455216894,0.628559774333202;
%                 0.604912610090194,-0.488869455216894,-0.628559774333202;
%                 0.148067858804268,0.916206732216432,0.372345448515765;
%                 -0.148067858804268,-0.916206732216432,-0.372345448515765;
%                 -0.411491282762496,-0.624112353132361,0.664197782951782;
%                 0.411491282762496,0.624112353132361,-0.664197782951782;
%                 0.960981254230386,0.180033558083600,0.210007016505529;
%                 -0.960981254230386,-0.180033558083600,-0.210007016505529;
%                 0.488869455216894,-0.395087389909806,0.777761280914777;
%                 -0.488869455216894,0.395087389909806,-0.777761280914777];
%             
%             crystal.Mfull = [1,0,0,0,0,0;
%                             1,0,0,0,0,0;
%                             1,0,0,0,0,0;
%                             1,0,0,0,0,0;
%                             0,1,0,0,0,0;
%                             0,1,0,0,0,0;
%                             0,0,0,1,0,0;
%                             0,0,0,1,0,0;
%                             0,0,1,0,0,0;
%                             0,0,1,0,0,0;
%                             0,0,0,0,0,1;
%                             0,0,0,0,0,1;
%                             0,0,0,0,0,1;
%                             0,0,0,0,0,1;
%                             0,0,0,0,1,0;
%                             0,0,0,0,1,0];
%   

            crystal.Mfull = crystal.M;           
            [rvec,U,Cmat] = mapDrawer(crystal.H,crystal.M);
            if ndims(U)>2
                hslider = uicontrol(hf,'style','slider','units','normalized','position',[0.7 0.7 0.2 0.03],'min',0,'max',1,'value',0.5,'sliderstep',[0.01 0.05],'callback',@sliderCallback);
                try
                    addlistener(hslider,'ContinuousValueChange',@ sliderCallback);
                catch
                    handle.addlistener(hslider,'ActionEvent',@ sliderCallback);
                end

            end
        else
            crystal = getCrystalInfo(crysname);
            [rvec,U,Cmat] = mapDrawer(crystal.H,crystal.M);
        end
        
        axes(ha1)
%         h = imagesc(log(rvec{1}),log(rvec{2}),U(:,:,51));
%         set(h,'cdata',squeeze(Cmat(:,:,51,:)))
        h = imagesc(log(rvec{1}),log(rvec{2}),U(:,:,:));
        set(h,'cdata',squeeze(Cmat(:,:,:,:)))
        set(gca,'yDir','normal','fontsize',14)

        grid on
        
        hp = impoint(ha1,0,0);      %creates the draggable point

        setColor(hp,'k')

        id = addNewPositionCallback(hp,@posChange);
        
        axes(ha2)
        hold on
        posChange([0 0])
        
        axes(ha1)
%         xlabel(['$$\ln \left(L_{',milstr{1},'}/L_{',milstr{3},'}\right)$$'],'interpreter','latex','fontname','calibri','fontsize',20,'interpreter','latex')
%         ylabel(['$$\ln \left(L_{',milstr{2},'}/L_{',milstr{3},'}\right)$$'],'interpreter','latex','fontname','calibri','fontsize',20,'interpreter','latex')

    end

%function to be called when the slider is moved (only 4 4 column matrices)
    function sliderCallback(hObject,eventdata)
        curPos = getPosition(hp);
        axes(ha1)
        
        cla(ha1)
        
        sliderVal = get(hObject,'value');
        sliceI = round(sliderVal*(length(rvec{3})-1))+1;
        h = imagesc(log(rvec{1}),log(rvec{2}),U(:,:,sliceI));
        set(h,'cdata',squeeze(Cmat(:,:,sliceI,:)))
        set(gca,'yDir','normal','fontsize',14)
        hp = impoint(ha1,curPos);
        id = addNewPositionCallback(hp,@posChange);
        posChange(curPos);
    end

end